---
customTheme : "presentation"

---

## –õ–µ–∫—Ü–∏—è 5. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ Go
### OZON

### –ú–æ—Å–∫–≤–∞, 2021


---

### –õ–µ–∫—Ü–∏–∏

1. <span style="color:gray">–í–≤–µ–¥–µ–Ω–∏–µ. –†–∞–±–æ—á–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π.</span>
2. <span style="color:gray">–ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö.</span>
3. <span style="color:gray">–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –æ—Å–Ω–æ–≤—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
4. <span style="color:gray">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –º–æ–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –Ω–∏–º–∏</span>
5. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ Go
6. <span style="color:gray">Protobuf –∏ gRPC</span>
7. <span style="color:gray">–†–∞–±–æ—Ç–∞ —Å –ë–î –≤ Go</span>
8. <span style="color:gray">–ë—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π. –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞. –ú–µ—Ç—Ä–∏–∫–∏. </span>

---

### –¢–µ–º—ã

–°–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –ø—Ä–æ:

1. –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å<!-- .element: class="fragment" -->
1. –ì–æ—Ä—É—Ç–∏–Ω—ã <!-- .element: class="fragment" -->
1. –ö–∞–Ω–∞–ª—ã <!-- .element: class="fragment" -->
1. –ü—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ <!-- .element: class="fragment" -->
1. –ì–æ–Ω–∫–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ <!-- .element: class="fragment" -->
1. –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã <!-- .element: class="fragment" -->


---

### –û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è

* üìΩÔ∏è - –ø–æ—Å–º–æ—Ç—Ä–∏ –≤–æ—Ä–∫—à–æ—É
* ‚öóÔ∏è - –ø—Ä–æ–≤–µ–¥–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
* üî¨ - –∏–∑—É—á–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ
* üìñ - –ø—Ä–æ—á–∏—Ç–∞–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
* ü™ô - –ø–æ–¥—É–º–∞–π –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
* üêû - –∑–∞–ø–æ–º–Ω–∏ –æ—à–∏–±–∫—É
* üî® - –∑–∞–ø–æ–º–Ω–∏ —Ä–µ—à–µ–Ω–∏–µ
* üèîÔ∏è - –æ–±–æ–π–¥–∏ –∫–∞–º–µ–Ω—å –ø—Ä–µ–¥–∫–Ω–æ–≤–µ–Ω—å—è
* ‚è∞ - —Å–¥–µ–ª–∞–π –ø–µ—Ä–µ—Ä—ã–≤
* üè° - –ø–æ–ø—Ä–æ–±—É–π –¥–æ–º–∞
* üí° - –æ–±—Å—É–¥–∏ —Å–≤–µ—Ç–ª—ã–µ –∏–¥–µ–∏
* üôã - –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å
* ‚ö° - –∑–∞–ø–æ–º–Ω–∏ –ø–∞–Ω–∏–∫—É

---

### –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å

- –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º -- —ç—Ç–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ, —Ç–æ –µ—Å—Ç—å –∫–æ–≥–¥–∞ —É –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –µ—Å—Ç—å —Å–≤–æ–π –Ω–∞–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è. –ê–Ω–∞–ª–æ–≥–∏—è: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø—Ä—è–º—ã–µ. <!-- .element: class="fragment" -->
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å -- —ç—Ç–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ. –¢–æ –µ—Å—Ç—å –∫–æ–≥–¥–∞ –º—ã –º–æ–∂–µ–º —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–±—â–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –∑–∞–¥–∞—á–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏.  <!-- .element: class="fragment" -->

‚ö° –í —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ —ç—Ç–∏ –¥–≤–∞ —Ç–µ—Ä–º–∏–Ω–∞ –ø—É—Ç–∞—é—Ç—Å—è. –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—ã—à–µ. <!-- .element: class="fragment" -->

---

### –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å

<img src="/images/lesson_5/parallel_and_concurency.png" />

source: https://joearms.github.io/#Index

---

### –ì–æ—Ä—É—Ç–∏–Ω—ã

Goroutine ‚Äî —ç—Ç–æ, –ø–æ —Å—É—Ç–∏, Coroutine, –Ω–æ —ç—Ç–æ Go, –ø–æ—ç—Ç–æ–º—É –º—ã –∑–∞–º–µ–Ω—è–µ–º –±—É–∫–≤—É C –Ω–∞ G –∏ –ø–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–æ Goroutine. <!-- .element: class="fragment" -->

–ö–∞–∫ –∏ –≤ –û–° –≤ Go –µ—Å—Ç—å —Å–≤–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–≥–¥–∞ –∫–∞–∫–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: <!-- .element: class="fragment" -->
1. –í Go <= 1.13 –±—ã–ª –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, —Ç.–µ. –∫–∞–∂–¥–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –∏—Å–ø–æ–ª–Ω—è–ª–∞—Å—å, –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏–ª–∞ –∫ –º–µ—Å—Ç—É, –≥–¥–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ –¥—Ä—É–≥—É—é –≥–æ—Ä—É—Ç–∏–Ω—É (—Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã, –º—å—é—Ç–µ–∫—Å—ã –∏ —Ç.–¥.) <!-- .element: class="fragment" -->
2. –° Go 1.14 –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å—Ç–∞–ª –≤—ã—Ç–µ—Å–Ω—è—é—â–∏–º. –¢–æ –µ—Å—Ç—å –æ–Ω –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—Ç. –ï–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–æ. <!-- .element: class="fragment" -->
 
üè° https://habr.com/ru/post/489862/ <!-- .element: class="fragment" -->

---

### –ì–æ—Ä—É—Ç–∏–Ω—ã

üè° –°—Ä–∞–≤–Ω–∏ –∫–∞–∫ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª–Ω—è—Ç—å—Å—è –Ω–∞ Go 1.13 –∏ Go >= 1.14.

```
package main

import (
    "fmt"
    "runtime"
    "time"
)

func main() {
    runtime.GOMAXPROCS(1)

    fmt.Println("The program starts ...")

    go func() {
        for {
        }
    }()

    time.Sleep(time.Second)
    fmt.Println("I got scheduled!")
}
```

---

### –ì–æ—Ä—É—Ç–∏–Ω—ã

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö:
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ go <!-- .element: class="fragment" -->
* C–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞ <!-- .element: class="fragment" -->
* –°–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã <!-- .element: class="fragment" -->
* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è <!-- .element: class="fragment" -->

–ù–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ –æ–Ω —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç. <!-- .element: class="fragment" -->

---

### –ì–æ—Ä—É—Ç–∏–Ω—ã

<img src="/images/lesson_5/books.jpg" />

---

### –ó–∞–ø—É—Å–∫ –≥–æ—Ä—É—Ç–∏–Ω—ã

–ö–∞–∂–¥–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –∏–º–µ–µ—Ç —Å–≤–æ–π —Å—Ç–µ–∫, –Ω–æ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –æ–Ω–∞ –¥–µ–ª–∏—Ç —Å —Å–∏—Å—Ç–µ–º–æ–π.

```go
go func(trolley Trolley) {
    burnBooks(trolley)
}(trolley)
```

```go
go func() {
    burnBooks(trolley)
}()
```

```go
go burnBooks(trolley)
```

```go
go trolley.Load(pile)
```

---

### –°–∫–æ–ª—å–∫–æ —Ç—É—Ç –≥–æ—Ä—É—Ç–∏–Ω?

```
func main() {
    fmt.Printf(
        "Goroutines: %d",
        runtime.NumGoroutine(),
    )
}
```

üè° ‚öóÔ∏è –ö–æ–≥–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è?

---

### –ß—Ç–æ –Ω–∞–ø–µ—á–∞—Ç–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞?

N.b.: "—á—Ç–æ –Ω–∞–ø–µ—á–∞—Ç–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞?", —ç—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –∏ "—á—Ç–æ —Ö–æ—Ç–µ–ª —Å–∫–∞–∑–∞—Ç—å –∞–≤—Ç–æ—Ä?".

```go
func main() {
    go fmt.Printf("Hello")
}
```

---

### –ó–∞–º—ã–∫–∞–Ω–∏–µ

–ó–∞–º—ã–∫–∞–Ω–∏–µ —ç—Ç–æ –∫–æ–≥–¥–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –¥–∞–∂–µ –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.

```go
func main() {
	for i := 0; i < 5; i++ {
		go func() {
			fmt.Print(i)
		}()
	}
	time.Sleep(2 * time.Second)
}
```
üè° ‚öóÔ∏è –ê —á—Ç–æ –µ—Å–ª–∏ `runtime.GOMAXPROCS(1)`?


---

### –ö–∞–∫–æ–π –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç —É i?

```go
func main() {
	for i := 0; i < 5; i++ {
		go func() {
			fmt.Printf("%v, %T, %v\n", i, i, &i)
		}()
	}
	time.Sleep(2 * time.Second)
}
```


---

### –ö–∞–Ω–∞–ª—ã

```go
chan T
```

* —Ä–∞–±–æ—Ç–∞—é—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–∏–ø–æ–º <!-- .element: class="fragment" -->
* –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã <!-- .element: class="fragment" -->
* –ø–æ—Ö–æ–∂–∏ –Ω–∞ –æ—á–µ—Ä–µ–¥–∏ FIFO <!-- .element: class="fragment" -->

---

### –û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ –∫–∞–Ω–∞–ª–∞–º–∏

```go

ch := make(chan int) // —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
ch <- 10 // –∑–∞–ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª
v := <-ch // –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ –∫–∞–Ω–∞–ª–∞
close(ch) // –∑–∞–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª

```

üè° https://habr.com/ru/post/308070/


---

### –ù–µ–±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã

```go
    ch := make(chan int)
```
<img src="/images/lesson_5/chan_1.png" />

---

### –ë—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã

```go
ch := make(chan int, 4)
```
<img src="/images/lesson_5/chan_2.png" />

---

### –ß–µ–º—É —Ä–∞–≤–µ–Ω –±—É—Ñ–µ—Ä –Ω–µ–±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞?

```go
    ch := make(chan int, ?)
```

```go
    func main() {
        ch := make(chan int)
        fmt.Println(cap(ch))
    }
```

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å –∏–∑ –ø—É—Å—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?

<img  src="/images/lesson_5/chan_3.png" />

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å –∏–∑ –ø—É—Å—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?

<img  src="/images/lesson_5/chan_4.png" />

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –ø–∏—Å–∞—Ç—å –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª?

<img  src="/images/lesson_5/chan_5.png" />

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –ø–∏—Å–∞—Ç—å –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª?

<img  src="/images/lesson_5/chan_6.png" />

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å –∏–∑ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?

<img  src="/images/lesson_5/chan_7.png" />

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å –∏–∑ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?

<img  src="/images/lesson_5/chan_8.png" />

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å –∏–∑ –ø—É—Å—Ç–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?

<img  src="/images/lesson_5/chan_9.png" />

---

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å –∏–∑ –ø—É—Å—Ç–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞?

<img  src="/images/lesson_5/chan_10.png" />

---

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≥–æ—Ä—É—Ç–∏–Ω –∫–∞–Ω–∞–ª–∞–º–∏

```go

func main() {
    var ch = make(chan struct{})
    go func() {
        fmt.Printf("Hello")
        ch <- struct{}{}
    }()
    <-ch
}
```

```go
func main() {
    var ch = make(chan struct{})
    go func() {
        fmt.Printf("Hello")
        <-ch
    }()
    ch <- struct{}{}
}
```

---

### –†–∞–±–æ—Ç–∞ —Å –∫–∞–Ω–∞–ª–∞–º–∏

* –ß—Ç–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞, –ø–æ–∫–∞ –æ–Ω –Ω–µ –∑–∞–∫—Ä—ã—Ç

```go
v, ok := <-ch // –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ñ–ª–∞–≥ "–æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç–∏" –∫–∞–Ω–∞–ª–∞
```

Producer:
```go
for _, t := range tasks {
    ch <- t
}
close(ch)
```
Consumer:

```go
for {
    x, ok := <-ch
    if !ok {
        break
    }
    fmt.Println(x)
}
```

---

### –†–∞–±–æ—Ç–∞ —Å –∫–∞–Ω–∞–ª–∞–º–∏

Producer:

```go
for _, t := range tasks {
    ch <- t
}
close(ch)
```

Consumer:
```go
for x := range ch {
    fmt.Println(x)
}
```

---

### –ü—Ä–∞–≤–∏–ª–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞–Ω–∞–ª–∞

–ö—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–∞–Ω–∞–ª?

- –ö–∞–Ω–∞–ª –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –≤ –Ω–µ–≥–æ –ø–∏—à–µ—Ç. <!-- .element: class="fragment" -->
- –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∏—Å–∞—Ç–µ–ª–µ–π, —Ç–æ —Ç–æ—Ç, –∫—Ç–æ —Å–æ–∑–¥–∞–ª –ø–∏—Å–∞—Ç–µ–ª–µ–π –∏ –∫–∞–Ω–∞–ª. <!-- .element: class="fragment" -->

---

### –ö–∞–Ω–∞–ª—ã: –æ–¥–Ω–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ

```go
    chan<- T // —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å
    <-chan T // —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
```

–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç?

```go
func f(out chan<- int) {
    <-out
}
func main() {
    var ch = make(chan int)
    f(ch)
}
```

---

### –ö–∞–Ω–∞–ª—ã: —Ç–∞–π–º–∞—É—Ç

```go
timer := time.NewTimer(10 * time.Second)
select {
case data := <-ch:
    fmt.Printf("received: %v", data)
case <-timer.C:
    fmt.Printf("failed to receive in 10s")
}
```

---

### –ö–∞–Ω–∞–ª—ã: –ø–µ—Ä–∏–æ–¥–∏–∫

```go

ticker := time.NewTicker(10 * time.Second)
defer ticker.Stop()
for {
    select {
    case <-ticker.C:
        fmt.Printf("tick")
    case <-doneCh:
        return
    }
}
```

---

### –ö–∞–Ω–∞–ª—ã: –∫–∞–∫ —Å–∏–≥–Ω–∞–ª—ã

```go
make(chan struct{}, 1)
```

–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª–∞:
```go
select {
    case notifyCh <- struct{}{}:
    default:
}
```

–ü—Ä–∏–µ–º–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª–∞:

```go
select {
    case <-notifyCh:
    case ...
}
```

---

### –ö–∞–Ω–∞–ª—ã: graceful shutdown

```go

interruptCh := make(chan os.Signal, 1)
signal.Notify(interruptCh, os.Interrupt, syscall.SIGTERM)
fmt.Printf("Got %v...\n", <-interruptCh)

```

---

### –ü—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

1. sync.WaitGroup
2. sync.Once
3. sync.Mutex
4. sync.RWMutex

---

### sync.WaitGroup: –∫–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç?

```go

func main() {
    const goCount = 5
    ch := make(chan struct{})
    for i := 0; i < goCount; i++ {
    go func() {
        fmt.Println("go-go-go")
        ch <- struct{}{}
        }()
    }
    for i := 0; i < goCount; i++ {
        <-ch
    }
}
```

---

### sync.WaitGroup: –æ–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ä—É—Ç–∏–Ω

```go
func main() {
    const goCount = 5
    wg := sync.WaitGroup{}
    wg.Add(goCount) // <===
    for i := 0; i < goCount; i++ {
        go func() {
            fmt.Println("go-go-go")
            wg.Done() // <===
        }()
    }
    wg.Wait()
}

---

### sync.WaitGroup: –æ–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ä—É—Ç–∏–Ω

```go
func main() {
    wg := sync.WaitGroup{}
    for i := 0; i < 5; i++ {
        wg.Add(1) // <===
        go func() {
            fmt.Println("go-go-go")
            wg.Done() // <===
        }()
    }
    wg.Wait()
}
```

---

### sync.WaitGroup: API

```go

type WaitGroup struct {
}

func (wg *WaitGroup) Add(delta int) // —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ WaitGroup.
func (wg *WaitGroup) Done() // —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –Ω–∞ 1.
func (wg *WaitGroup) Wait() // –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ —Å—á–µ—Ç—á–∏–∫ WaitGroup –Ω–µ –æ–±–Ω—É–ª–∏—Ç—Å—è.
```

---

### sync.Once: –∫–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç?

```go

func main() {
    var once sync.Once
    onceBody := func() {
        fmt.Println("Only once")
    }
    var wg sync.WaitGroup
    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func() {
            once.Do(onceBody)
            wg.Done()
        }()
    }
    wg.Wait()
}
```

---

### sync.Once: –ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–∏–º–µ—Ä)

```
type List struct {
    once sync.Once
...
}

func (l *List) PushFront(v interface{}) {
    l.init()
...
}

func (l *List) init() {
    l.once.Do(func() {
    ...
    })
}
```

---

### sync.Once: —Å–∏–Ω–≥–ª—Ç–æ–Ω (–ø—Ä–∏–º–µ—Ä)

```go

type singleton struct {
}

var instance *singleton
var once sync.Once

func GetInstance() *singleton {
    once.Do(func() {
        instance = &singleton{}
    })
    return instance
}
```

---

### sync.Mutex: –∫–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç?

```go

func main() {
    wg := sync.WaitGroup{}
    v := 0
    for i := 0; i < 1000; i++ {
        wg.Add(1)
        go func() {
            v++
            wg.Done()
        }()
    }
    wg.Wait()
    fmt.Println(v)
}
```

---

### sync.Mutex

```go

$ GOMAXPROCS=1 go run mu.go
1000
$ GOMAXPROCS=4 go run mu.go
947
$ GOMAXPROCS=4 go run mu.go
956
```

---

### sync.Mutex

```go 

func main() {
    wg := sync.WaitGroup{}
    mu := sync.Mutex{}
    v := 0
    for i := 0; i < 1000; i++ {
        wg.Add(1)
        go func() {
            mu.Lock() // <===
            v++
            mu.Unlock() // <===
            wg.Done()
        }()
    }
    wg.Wait()
    fmt.Println(v)
}
```

---

### sync.Mutex: –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–ü–æ–º–µ—â–∞–π—Ç–µ –º—å—é—Ç–µ–∫—Å –≤—ã—à–µ —Ç–µ—Ö –ø–æ–ª–µ–π, –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ç–æ—Ä—ã–º –æ–Ω –±—É–¥–µ—Ç –∑–∞—â–∏—â–∞—Ç—å

```
var sum struct {
    mu sync.Mutex // <=== —ç—Ç–æ—Ç –º—å—é—Ç–µ–∫—Å –∑–∞—â–∏—â–∞–µ—Ç
    i int // <=== –ø–æ–ª–µ –ø–æ–¥ –Ω–∏–º
}
```

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ defer, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–µ–∫ –≤—ã—Ö–æ–¥–∞
```
func doSomething() {
    mu.Lock()
    defer mu.Unlock()
    err := ...
    if err != nil {
        return // <===
    }
    err = ...
    if err != nil {
        return // <===
    }
    return // <===
}
```

---

### –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º—å—é—Ç–µ–∫—Å–æ–≤

```go

type Container struct {
	sync.Mutex
	counters map[string]int
}

func (c Container) inc(name string) {
	c.Lock()
	defer c.Unlock()
	c.counters[name]++
}

func main() {
	c := Container{counters: map[string]int{"a": 0, "b": 0}}

	doIncrement := func(name string, n int) {
		for i := 0; i < n; i++ {
			c.inc(name)
		}
	}

	go doIncrement("a", 100000)
	go doIncrement("a", 100000)

	// Wait a bit for the goroutines to finish
	time.Sleep(300 * time.Millisecond)
	fmt.Println(c.counters)
}

```

---

### –î–µ–¥–ª–æ–∫–∏

<img  src="/images/lesson_5/deadlock.png" />

---

### –ì–æ–Ω–∫–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

–í —á–µ–º –ø—Ä–æ–±–ª–µ–º–∞, –∫—Ä–æ–º–µ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è?

```go
func main() {
    wg := sync.WaitGroup{}
    text := ""
    wg.Add(2)
    go func() {
        text = "hello world"
        wg.Done()
    }()
    go func() {
        fmt.Println(text)
        wg.Done()
    }()
    wg.Wait()
}
```

---

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–Ω–æ–∫

```go

$ go test -race mypkg
$ go run -race mysrc.go
$ go build -race mycmd
$ go install -race mypkg

```

---

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–Ω–æ–∫

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ race –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞:

```go
func main() {
    for i := 0; i < 10000; i++ {
        go func() {
            time.Sleep(time.Second)
        }()
    }
    time.Sleep(time.Second)
}
```

–ú–æ–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç—ã:

```
// +build !race
package foo
// The test contains a data race. See issue 123.
func TestFoo(t *testing.T) {
// ...
}
```

---

### Context

> A Context carries a deadline, a cancellation signal, and other values across API boundaries

```go
type Context interface {
  Deadline() (deadline time.Time, ok bool)
  Done() <-chan struct{}
  Err() error
  Value(key interface{}) interface{}
}
```

```go
package context
‚Äã
var Canceled = errors.New("context canceled")
‚Äã
var DeadlineExceeded error = deadlineExceededError{}
// Stream generates values with DoSomething and sends them to out
// until DoSomething returns an error or ctx.Done is closed.
func Stream(ctx context.Context, out chan<- Value) error {
  for {
    v, err := DoSomething(ctx)
    if err != nil {
      return err
    }
    select {
    case <-ctx.Done():
      return ctx.Err()
    case out <- v:
    }
  }
}
```

---

### Context

–ö–æ–Ω—Ç–µ–∫—Å—Ç—ã

```go
context.Background()
context.TODO()
```

- Background: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–π –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. –û–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è, –Ω–µ –∏–º–µ–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏ –Ω–µ –∏–º–µ–µ—Ç –∫—Ä–∞–π–Ω–µ–≥–æ —Å—Ä–æ–∫–∞. –û–±—ã—á–Ω–æ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ —Ç–µ—Å—Ç–∞–º–∏, –∞ —Ç–∞–∫–∂–µ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

- TODO: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–π –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `context.TODO()`, –∫–æ–≥–¥–∞ –Ω–µ—è—Å–Ω–æ, –∫–∞–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –∏–ª–∏ –æ–Ω –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ—Å–∫–æ–ª—å–∫—É –æ–∫—Ä—É–∂–∞—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –µ—â–µ –Ω–µ –±—ã–ª–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞).

---

### Context: WithTimeout

WithTimeout:
```go
    ctx, cancel := context.WithTimeout(ctx, timeout)
    defer cancel()

    resp, err := client.DescribeTaskV1(ctx, req)
```

---

### Context: WithCancel

```
gen := func(ctx context.Context) <-chan int {
    dst := make(chan int)
    n := 1
    go func() {
      for {
        select {
        case <-ctx.Done():
          return // returning not to leak the goroutine
        case dst <- n:
          n++
        }
      }
    }()
    return dst
  }
‚Äã
  ctx, cancel := context.WithCancel(context.Background())
  defer cancel() // cancel when we are finished consuming integers
‚Äã
  for n := range gen(ctx) {
    fmt.Println(n)
    if n == 5 {
      break
    }
  }
```

---

### Context: WithDeadline

```go
    return WithDeadline(parent, time.Now().Add(timeout))
```

---

### Context: WithValue

```go
package user
‚Äã
import "context"
‚Äã
type User struct {...}
‚Äã
type key int
‚Äã
var userKey key
‚Äã
func NewContext(ctx context.Context, u *User) context.Context {
    return context.WithValue(ctx, userKey, u)
}
‚Äã
func FromContext(ctx context.Context) (*User, bool) {
  u, ok := ctx.Value(userKey).(*User)
  return u, ok
}
```

---

### Context: metadata

–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ - —á–∞—Å—Ç–Ω—ã–π —Å–ª—É—á–∞–π –¥–ª—è WithValue

–ü–æ–ª—É—á–µ–Ω–∏–µ:
```go
import "google.golang.org/grpc/metadata"
‚Äã
var user string
meta, found := metadata.FromIncomingContext(ctx)
if found {
  for key, values := range meta {
    if !strings.Contains(key, "ocp") {
      continue
    }
    if len(values) == 0 {
      continue
    }
    value := values[0]
    span.SetTag(key, value)
  }
}
```

---

### Context: metadata

–û—Ç–ø—Ä–∞–≤–∫–∞:

```go
md := metadata.New(map[string]string{
  "key1": "val1",
  "key2": "val2",
})
md := metadata.Pairs(
    "key1", "val1",
    "key1", "val1-2", // "key1" will have map value []string{"val1", "val1-2"}
    "key2", "val2",
)
ctx := metadata.NewOutgoingContext(context.Background(), md)
```

---

### Context: metadata

–ß—Ç–æ –∏–∑ —Å–µ–±—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ üî¨

```go
type MD map[string][]string
‚Äã
func FromIncomingContext(ctx context.Context) (md MD, ok bool) {
  md, ok = ctx.Value(mdIncomingKey{}).(MD)
  return
}
```

> HTTP Authorization header is added as authorization gRPC request header

> HTTP headers that start with 'Grpc-Metadata-' are mapped to gRPC metadata (prefixed with grpcgateway-)